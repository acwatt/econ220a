#==============================================================================
file: ps2.jl
description: estimating model for Problem Set #2 of Econ 220A (UC Berkeley, 2022),
             Demand Estimation and Merger Simulation. The problem set file is
             . The two original files are:
             - PSET1-2019-2.pdf
             - ps1data.csv
author: Aaron C Watt (UCB Grad Student, Ag & Resource Econ)
notes:
    - setting up problems
==============================================================================#

#?==============================================================================
#?                                PACKAGES
#?==============================================================================
# For Stats stuff
using Statistics, StatsBase, StatsPlots, StatsFuns, GLM
using CovarianceMatrices, StatsModels, FixedEffectModels
# For dataframes
using DataFrames, CSV, DataFramesMeta, Chain
# Random Variable distributions
using Random, Distributions
Random.seed!(0);
# Optimizing functions
# using Optim, NLSolversBase
# using LinearAlgebra: diag
# using JuMP, KNITRO




#?==============================================================================
#?                                 SETUP
#?==============================================================================
# Load data
df = DataFrame(CSV.File(string(dirname(@__FILE__), "/ps1data.csv")))








#?==============================================================================
#?==============================================================================
#?==============================================================================
#?                        QUESTION 1: LOGIT
#?==============================================================================
#?==============================================================================
#?==============================================================================
############# PART A
# Estimate an aggregate Logit model using OLS (Product 3 is reference group)

# Create the logit dependent variable: δⱼ,ₙ = log(sjn) - log(sj0);  sj0 = outside share (1-Σsjn)

logit_(x) = StatsFuns.logit(x)
formula1a = @formula(sjn ~ pjn + d1 + d2  + d4 + d5 + x1 + x2)
reg1a = @time reg(df, formula1a, Vcov.cluster(:market))
reg1a = @time reg(df, @formula(sjn ~ pjn), Vcov.cluster(:market))
reg1a = @time reg(df, @formula(logit_(sjn) ~ pjn), Vcov.cluster(:market))
modelmatrix(@formula(logit(sjn) ~ pjn), df)

logit = glm(@formula(sjn ~ pjn), df, Binomial(), ProbitLink())



market_sums = @chain df begin
    groupby(:market)
    combine(:sjn => (x -> 1-sum(x)) => :sj0, :sjn => sum => :sja)
    groupby(:market)
    combine([:sj0, :sja] => (a,b) -> a+b => :sum)
end
leftjoin(df, market_sums, on = :market)

function add_logit_depvar!(df)
end

















#?==============================================================================
#?==============================================================================
#?==============================================================================
#?                        QUESTION 2: NESTED LOGIT
#?==============================================================================
#?==============================================================================
#?==============================================================================





















#?==============================================================================
#?==============================================================================
#?==============================================================================
#?                        QUESTION 3: MARGINAL COSTS
#?==============================================================================
#?==============================================================================
#?==============================================================================





















#?==============================================================================
#?==============================================================================
#?==============================================================================
#?                        QUESTION 4: PRICING EQUATIONS
#?==============================================================================
#?==============================================================================
#?==============================================================================























#?==============================================================================
#?==============================================================================
#?==============================================================================
#?                        QUESTION 5: RANDOM COEFFICIENTS MODEL
#?==============================================================================
#?==============================================================================
#?==============================================================================



























#*==============================================================================
#*==============================================================================
#*==============================================================================
#*                                   NOTES
#*==============================================================================
#*==============================================================================
#*==============================================================================










